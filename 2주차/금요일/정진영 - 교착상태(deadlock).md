# 교착 상태(deadlock)와 해결 방법

> <목차>
>
> 1. 자원 할당 그래프와 교착 상태
> 2. 교착 상태 발생 조건 (4)
> 3. 교착 상태 해결 방법 (4)

<br>

<hr>

![교착 상태](<https://hoyeonkim795.github.io/assets/img/%EA%B5%90%EC%B0%A9%EC%83%81%ED%83%9C_%EA%B0%9C%EB%85%90%EA%B3%BC_%EB%B0%9C%EC%83%9D%EC%9B%90%EC%9D%B8%20(1).png>)
<br>
_일상에서 볼 수 있는 교착 상태_

## 1. 교착 상태란 ?

교착 상태와 관련된 문제를 먼저 살펴 보자.

![식사하는 철학자](image.png)
<br>
_gpt 생성 이미지_

> **식사하는 철학자 문제**  
> 다섯 명의 철학자가 둥근 테이블에 앉아있고, 각 철학자 사이에는 포크가 있으며, 철학자는 식사하거나 생각하는 상태만 가능하다.
> 규칙은 다음과 같다.
>
> 1. 계속 생각하다가 왼쪽 포크가 사용 가능하면 집어든다.
> 2. 계속 생각하다가 오른쪽 포크가 사용 가능하면 집어든다.
> 3. 왼쪽과 오른쪽 포크를 모두 집어들면 정해진 시간 동안 식사를 한다.
> 4. 식사 시간이 끝나면 오른쪽 포크를 내려놓는다.
> 5. 오른쪽 포크를 내려 놓은 뒤 왼쪽 포크를 내려놓는다.
> 6. 다시 1번부터 반복한다.

<br><br>

마찬가지로 한정된 자원을 <u>두 개 이상의 프로세스 혹은 스레드가 서로가 가진 리소스를 기다리는 상태</u>를
<br>
**교착 상태(deadlock)** 이라고 한다.

![교착 상태 다이어그램](https://blog.kakaocdn.net/dn/bHk2ju/btr7s3JYoPj/OLlYSJ7c8yxjr6910nUvsK/img.png)
<br>
_출처 : 혼자 공부하는 컴퓨터구조 + 운영체제_

### 교착 상태를 해결하기 위해서는?

1. 교착 상태가 발생했을 때의 상황을 정확하게 그림으로 표현할 수 있어야 한다. : **자원 할당 그래프**
2. 교착 상태가 일어나는 근본적인 이유를 이해해야 한다 : **교착 상태 원인**

#### 자원 할당 그래프로 표현하는 교착 상태

> <u>자원 할당 그래프란?</u>(Resource Allocation Graph)
>
> 프로세스와 자원 간의 관계를 시각적으로 표현하는 그래프  
> <u>프로세스는 원으로, 자원은 사각형으로 표현하고 관계를 화살표로 표현한다.</u>  
> 사용할 수 있는 자원의 개수는 자원 사각형 내에 점으로 표현한다.  
> <br>
> 교착 상태 발생 조건을 파악하는데 많이 활용된다.
>
> - 어떤 프로세스가 어떤 자원을 할당 받아 사용 중인가?
> - 어떤 프로세스가 어떤 자원을 기다리고 있는가?

![자원 활용 그래프](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FbveasW%2Fbtr7n2RXC18%2FoMOAcnFJuhWS97ToRCNrEK%2Fimg.png)
_출처 : 혼자 공부하는 컴퓨터구조 + 운영체제_

<br>

### 앞서 봤던 교착 상태를 자원 활용 그래프로 그리면 다음과 같다.

![식사하는 철학자 자원 활용 그래프](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2Fcd3v53%2Fbtr7LrXhyZH%2FPQAU7XN0FmnLoly7bKpKc1%2Fimg.png)

자원 활용 그래프로 확인할 수 있는 것 처럼, 그래프가 **원의 형태**를 하고 있을 때 교착 상태가 발생한다.

## 2. 교착 상태의 네 가지 원인 === 교착 상태가 발생할 조건

_cs 질문 기출_

> 교착 상태가 발생하는 원인은 또한 교착 상태가 발생할 조건이다.  
> <u>교착 상태는 다음 네 가지의 조건이 모두 발생할 때 생긴다.</u>  
> <br>
> 하나라도 발생하지 않으면 교착 상태를 발생되지 않는다.

---

1. **상호 배제 (Mutual exclusion)**  
   한 프로세스가 사용하는 자원을 다른 프로세스가 사용할 수 없는 상태  
   === 자원을 공유해서 사용할 수 없다.

2. **점유와 대기(Hold and wait)**  
   프로세스가 이미 하나 이상의 자원을 취득(hold)한 상태에서  
   다른 프로세스가 사용하는 리소스를 기다린다.(wait)

3. **비선점(No preemption)**  
   자원 반환(resource release)은 오직 그 자원을 취득한 프로세스만 할 수 있다.  
   === 어떤 프로세스도 다른 프로세스의 자원을 강제로 빼앗지 못한다.

4. **원형 대기(Circular wait)**  
   프로세스들이 순환(circular) 형태로 서로의 자원을 기다린다.

---

## 3. 교착 상태 해결 방법 네 가지

교착 상태를 해결하기 위한 방법으로는 세 가지가 있다.

> 1. 교착 상태 예방 (데드락 방지)
> 2. 교착 상태 회피
> 3. 교착 상태 감지 후 복구
> 4. 교착 상태 무시

네 가지의 방법을 이해하고, 어떤 방법이 가장 현실적이며 사용 가능성이 높은지 생각해볼 수 있어야 한다.

### 교착 상태 예방 (Deadlock prevention)

교착 상태의 네 가지 조건 중 하나라도 충족되지 않는다면? ==> 교창 상태를 예방할 수 있다!

교착 상태 발생 조건 중 하나를 없애버리는 방법으로 교착 상태의 조건을 충족하지 않음으로써 사전에 발생하지 않도록 예방하는 방법이다.

---

1.  **상호 배제를 없앤다면 ?**

    모든 자원을 공유 가능하게 하면 된다!  
    `이론적으로는 가능하나 현실적으로는 불가능하다.`

2.  **점유와 대기(hold and wait)를 없앤다면 ?**

    1.  사용할 리소스를 모두 획득한 뒤에 시작 : 특정 프로세스에 모든 자원 할당
    2.  리소스를 전혀 가지지 않은 상태에서만 리소스 요청 : 아예 할당하지 않는 방식으로 자원 배분

    `자원의 활용률을 저하시킬 수 있는 방식`  
    예를 들어, 자원 A와 B를 모두 프로세스 C에 할당한다면?

    자원 A를 처리할 동안 자원 B는 방치시킬 수 있다.  
    자원 B를 요구하는 프로세스가 많다면 비효율적인 방식일 수 있다.

3.  **비선점을 없앤다면?**

    추가적인 리소스를 기다려야 한다면 이미 획득한 리소스를 다른 프로세스가 선점 가능하도록 한다.

    `효과가 선점이 가능한 자원(CPU)에 한정되어 있다.`

4.  **원형 대기 조건을 없앤다면 ?**

    자원에 번호를 붙이고 오름차순으로 할당하면 원형 대기는 발생하지 않는다.

    `어던 자원에 어떤 번호를 붙이는가에 따라 활용률이 달라진다.`  
    `모든 자원에 번호를 붙이는 것은 어려운 작업이다.`

<br>

### 교착 상태 회피

교착 상태 예방 방법은 교착 상태가 발생하지 않음을 보장할 수 있으나 부작용이 따른다.

교착 상태는 무분별한 자원 할당으로 인해 발생했다고 가정해본다.  
교착 상태가 발생하지 않을 만큼, <u>배분할 수 있는 자원의 양을 고려하여</u> 교착 상태가 발생하지 않을 만큼 자원 배분을 한다면 교착 상태를 회피할 수 있다.

> 교착 상태를 회피할 수 있도록 한정된 자원을 프로세스들에게 할당하는 것을 **교착 상태 회피**라 한다.
>
> - 안전 순서열 : 교착 상태 없이 안전하게 프로세스들에 자원을 할당할 수 있는 순서
> - 안정 상태 : 교착 상태 없이 모든 프로세스가 자원을 할당 받고 종료될 수 있는 상태 (안전 순서열인 상태)
> - 불안정 상태 : 교착 상태가 발생할 수도 있는 상태 (안전 순서열이 없는 상태)

<br>
<hr>
할당 가능한 자원은 12, 안전 순서열이 존재한다면 프로세스 순서를 생각해보자.

(예시 1)
| 프로세스 | 요구량 | 현재 사용량 |
| -------- | ------ | ----------- |
| P1 | 10 | 5 |
| P2 | 4 | 2 |
| P3 | 9 | 2 |

(예시 2)
| 프로세스 | 요구량 | 현재 사용량 |
| -------- | ------ | ----------- |
| P1 | 10 | 5 |
| P2 | 4 | 2 |
| P3 | 9 | 3 |

<hr>

안전 상태에서 안정 상태로 움직이는 경우에만 자원을 할당하는 방식이 교착 상태 회피이다.  
관련 알고리즘으로는 [은행원 알고리즘](https://velog.io/@minu-j/%EC%9A%B4%EC%98%81%EC%B2%B4%EC%A0%9C-%EB%A7%8C%ED%99%94%EB%A1%9C-%EC%95%8C%EC%95%84%EB%B3%B4%EB%8A%94-%EC%9D%80%ED%96%89%EC%9B%90-%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98-%EA%B5%90%EC%B0%A9%EC%83%81%ED%83%9C-%ED%9A%8C%ED%94%BC-%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98)이 있다.

\* 은행원 알고리즘 (Banker Algorithm) ?  
자원 요청을 허락해줬을 때 데드락 발생 가능성이 있다면 안전할 때 까지 계속 요청을 거절하는 알고리즘

<br>

### 교착 상태 감지 후 복구

교착 상태의 발생을 인정하고 사후 조치하는 방식으로,  
일단 요구된 자원을 <u>프로세스에 할당</u>해주고 교착 상태가 <u>감지되면 회복하는 것</u>을 말한다.

회복(복구)하는 방식에는 두 가지가 있다.

> 1. 선점을 통한 회복 : 교착 상태가 회복될 때 까지 한 프로세스 씩 자원을 몰아주는 방식
> 2. 프로세스 강제 종료를 통한 회복
>
> - 모든 프로세스 강제 종료
> - 교착 상태가 해결될 때 까지 한 프로세스씩 강제 종료 : `오버 헤드 가능성이 있지만 모든 작업 내영을 잃을 위험성이 적다.`

### 교착 상태 무시

교착 상태가 드물게 발생한다면? 무시해도 되지 않을까?

<br>
<hr>

## 교착 상태 (deadlock) 관련 질문

1. 교착 상태란 무엇인가 ?
2. 교착 상태가 발생하는 네 가지 조건은 무엇인가?
3. 교착 상태가 프론트엔드 개발에서 발생할 수 있는 사례는?
4. 교착 상태를 해결하거나 방지하는 방법은?
5. 비동기 HTTP 요청에서 교착 상태가 발생시 해결 방법은?

<br>

### 3. 교착 상태가 프론트엔드 개발에서 발생할 수 있는 사례는?

1. 비동기 요청(Async)에서의 deadlock

   두 개의 API 요청을 병렬적으로 보내고, 각각 서로의 응답을 기다리는 경우 발생할 수 있다.

2. 웹 워커와 메인 스레드의 deadlock

   웹 워커가 특정 데이터를 처리하는 동안 메인 스레드가 해당 데이터를 기다리는 경우, 양쪽이 서로의 응답을 기다리며 교착 상태가 발생할 수 있다.

<br>

### 4. 교착 상태를 해결하거나 방지하는 방법은?

1.  자원 요청 순서를 정하기 (Resource Ordering)

    모든 프로세스(혹은 요청)가 자원을 일정한 순서로 요청하도록 강제하면 순환 대기(Circular Wait)를 방지할 수 있다.

    예를 들어, A → B → C 순서로 자원을 요청하도록 강제하면 교착 상태를 예방할 수 있다.

2.  타임아웃 설정 (Timeout Handling)

    특정 자원을 기다리는 시간이 일정 시간을 초과하면 요청을 취소하는 방식으로 교착 상태를 방지할 수 있다.
    예를 들어, 비동기 요청 시 일정 시간이 지나면 요청을 중단하고 다른 처리를 수행하면 무한 대기를 방지할 수 있다.

3.  선점 기법 (Preemption)

        필요할 경우 이미 할당된 자원을 강제로 회수하여 다른 프로세스가 사용할 수 있도록 하는 방식을 사용한다.

        예를 들어, 프론트엔드에서는 백그라운드 API 요청을 중단하고 다시 시도하는 방식이 이에 해당할 수 있다.

4.  은행가 알고리즘 (Banker's Algorithm)

        시스템이 현재 상태에서 안전한지 확인하고, 자원을 할당할지 여부를 결정하는 알고리즘을 활용한다.

        웹 애플리케이션에서는 백엔드에서 동시 요청 수를 제한하거나, 우선순위 기반 요청 큐를 사용하여 특정 요청이 차단되지 않도록 하는 방식으로 활용할 수 있다.

<br>

### 5. 비동기 HTTP 요청에서 교착 상태가 발생시 해결 방법은?

4번 질문에 대한 답변을 활용하여 몇 가지 답변을 생각해본다면,

1.  요청 순서 조정 (Request Ordering)

        특정 API 요청을 순차적으로 실행하고, 하나의 요청이 완료된 후 다음 요청을 수행하도록 하면 교착 상태를 방지할 수 있다.

        예를 들어, Promise.all() 대신 Promise.allSettled()을 사용하여 일부 요청이 실패하더라도 다른 요청이 계속 실행되도록 할 수 있습니다.

2.  타임아웃 설정 (Timeout Handling)

    요청이 일정 시간 동안 응답이 없으면 자동으로 요청을 취소하도록 설정할 수 있습니다.
